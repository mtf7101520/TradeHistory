//@version=5
strategy("åŠ¨æ€è°ƒæ•´çš„å–å‡ºç­–ç•¥_CMFä¼˜åŒ–ç‰ˆ", overlay=true, format=format.price, precision=2, calc_on_every_tick=false)

//æ™®é€šå‡çº¿ç»˜åˆ¶ start
// è®¾ç½®EMAçº¿
ema1 = ta.ema(close, 144)
ema2 = ta.ema(close, 169)
ema3 = ta.ema(close, 12)
ema5 = ta.ema(close, 26)
ema6 = ta.ema(close, 9)

// Define channel colors
buyColor = ema3 > ema1 or ema3 > ema2 ? color.new(color.green, 0) : na
sellColor = ema3 < ema2 or ema3 < ema1 ? color.new(color.red, 0) : na

buy2Color = ema6 > ema5 or ema6 > ema3 ? color.new(color.green, 0) : na
sell2Color = ema6 < ema3 or ema6 < ema5 ? color.new(color.red, 0) : na

// Plot the channel
plot(ema1, color=color.black, linewidth=1)
plot(ema2, color=color.purple, linewidth=1)
plot(ema3, color=color.rgb(176, 39, 39), linewidth=2)
plot(ema5, color=color.rgb(0, 0, 0), linewidth=1)
plot(ema6, color=color.rgb(255, 82, 82), linewidth=1)
fill(plot(ema1), plot(ema2), color=buyColor)
fill(plot(ema2), plot(ema1), color=sellColor)
fill(plot(ema3), plot(ema5), color=buy2Color)
fill(plot(ema5), plot(ema3), color=sell2Color)
//æ™®é€šå‡çº¿ç»˜åˆ¶ end

// åŠ¨æ€ä¹°å–å‚æ•°
sellPrecent = input.int(1, title="sellPrecent åŸºæ•°0.3,0.6,0.9", step=1)
buffer = input.float(0.05, title="CMF Buffer", step=0.01)  // è®¾ç½®CMFçš„ç¼“å†²åŒºèŒƒå›´ï¼Œé˜²æ­¢0è½´é™„è¿‘çš„å™ªéŸ³ä¿¡å·
firstSell = input.float(20, title="sellPrecent1", step=1)
secondSell = input.float(40, title="sellPrecent2", step=1)

// æ­¢æŸæ¯”ä¾‹å‚æ•°
stopLossPercentage = input.float(2, title="Stop Loss Percentage", step=1)  // æ­¢æŸæ¯”ä¾‹ï¼Œé»˜è®¤2%

// æ ¹æ®ATRåŠ¨æ€è°ƒæ•´å–å‡ºæ¡ä»¶
upPercentage5 = 1.03 + (sellPrecent / 100)  // åŠ¨æ€è°ƒæ•´çš„ä¸Šæ¶¨å¹…åº¦ 3% åŸºæ•°
upPercentage10 = 1.06 + (sellPrecent / 100)  // åŠ¨æ€è°ƒæ•´çš„ä¸Šæ¶¨ 6% åŸºæ•°
upPercentage15 = 1.09 + (sellPrecent/ 100)  // åŠ¨æ€è°ƒæ•´çš„ä¸Šæ¶¨ 9% åŸºæ•°

// è·å–ä¹°å…¥ä»·æ ¼
var float entryPrice = na

// === CMFä¼˜åŒ–æŒ‡æ ‡ç³»ç»Ÿ START ===
// Chaikin Money Flow (CMF) åŸºç¡€è®¡ç®—
lengthCMF = input.int(20, title="cmfLength", minval=1)
ad = close == high and close == low or high == low ? 0 : ((2 * close - low - high) / (high - low)) * volume
mf = math.sum(ad, lengthCMF) / math.sum(volume, lengthCMF)

// CMFç©¿è¶Šä¿¡å·
buyCMF = ta.crossover(mf, buffer)      // ç¬æ—¶èµ„é‡‘æµå…¥ä¿¡å·
sellCMF = ta.crossunder(mf, -buffer)  // ç¬æ—¶èµ„é‡‘æµå‡ºä¿¡å·

// CMFå¯è§†åŒ–
plot(mf, color=color.purple, linewidth=2, title="CMF")
hline(0, "CMFé›¶è½´", color=color.gray, linestyle=hline.style_dashed)
hline(buffer, "ä¹°å…¥ç¼“å†²", color=color.green, linestyle=hline.style_dotted, linewidth=1)
hline(-buffer, "å–å‡ºç¼“å†²", color=color.red, linestyle=hline.style_dotted, linewidth=1)
// === CMFä¼˜åŒ–æŒ‡æ ‡ç³»ç»Ÿ END ===

// å·²å–å‡ºæ¯”ä¾‹å˜é‡
var float totalSoldPercentage = 0.0

// === ä¹°å…¥ä¿¡å·é€»è¾‘ ===
// åŸºç¡€ä¹°å…¥ä¿¡å·ï¼šCMFä¸Šç©¿buffer
buySignal = buyCMF

// æ„å»ºä¹°å…¥æ¶ˆæ¯
buyMsg = "ğŸš€ ä¹°å…¥ä¿¡å·è§¦å‘\n"
buyMsg := buyMsg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
buyMsg := buyMsg + "ğŸ« æ ‡çš„: " + syminfo.ticker + "\n"
buyMsg := buyMsg + "ğŸ’² ä»·æ ¼: " + str.tostring(close, "#.##") + "\n"
buyMsg := buyMsg + "ğŸ“Š CMFå€¼: " + str.tostring(mf, "#.###") + "\n"
buyMsg := buyMsg + "ğŸ›¡ï¸ æ­¢æŸä½: " + str.tostring(close * (1 - stopLossPercentage/100), "#.##") + " (-" + str.tostring(stopLossPercentage) + "%)\n"
buyMsg := buyMsg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if (buySignal)
    strategy.entry("Buy", strategy.long, alert_message=buyMsg)
    entryPrice := close
    totalSoldPercentage := 0.0
    alert(buyMsg, alert.freq_once_per_bar)

// åŠ¨æ€è°ƒæ•´çš„å–å‡ºæ¡ä»¶
sellCondition5 = close >= entryPrice * upPercentage5
sellCondition10 = close >= entryPrice * upPercentage10
sellCondition15 = close >= entryPrice * upPercentage15

// æ•´åˆå–å‡ºä¿¡å·
sellAlert = sellCMF

// æ­¢æŸé€»è¾‘
stopLossCondition = close <= entryPrice * (1 - stopLossPercentage / 100)

// æ„å»ºæ­¢æŸæ¶ˆæ¯
slMsg = "ğŸ›‘ æ­¢æŸè§¦å‘\n"
slMsg := slMsg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
slMsg := slMsg + "ğŸ« æ ‡çš„: " + syminfo.ticker + "\n"
slMsg := slMsg + "ğŸ’² å–å‡ºä»·: " + str.tostring(close, "#.##") + "\n"
slMsg := slMsg + "ğŸ“‰ äºæŸå¹…åº¦: " + str.tostring(stopLossPercentage) + "%\n"
slMsg := slMsg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if (stopLossCondition and strategy.position_size > 0)
    strategy.close("Buy", alert_message=slMsg)
    totalSoldPercentage := 100.0

// åˆ†é˜¶æ®µå–å‡º
var array<float> sellLevels = array.from(upPercentage5, upPercentage10, upPercentage15)
var array<float> sellPercents = array.from(firstSell, secondSell, 100 - firstSell - secondSell)

for i = 0 to 2
    if close >= entryPrice * array.get(sellLevels, i) and totalSoldPercentage < 100
        sellQty = math.min(array.get(sellPercents, i), 100 - totalSoldPercentage)
        
        // è®¡ç®—ç›¸å…³æ•°æ®
        sellPrice = close
        profitPercent = ((sellPrice - entryPrice) / entryPrice) * 100
        remainingPercent = 100 - (totalSoldPercentage + sellQty)
        
        // æ„å»ºæé†’æ¶ˆæ¯
        msg = "ğŸ”” åˆ†æ‰¹å–å‡º #" + str.tostring(i + 1) + "\n"
        msg := msg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        msg := msg + "ğŸ’° å–å‡ºä»·æ ¼: $" + str.tostring(sellPrice, "#.##") + "\n"
        msg := msg + "ğŸ“ˆ æ¶¨å¹…: " + str.tostring(profitPercent, "#.##") + "%\n"
        msg := msg + "ğŸ“Š æœ¬æ¬¡å–å‡º: " + str.tostring(sellQty, "#.##") + "%\n"
        msg := msg + "ğŸ’¼ å‰©ä½™ä»“ä½: " + str.tostring(remainingPercent, "#.##") + "%\n"
        msg := msg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        strategy.close("Buy", qty_percent=sellQty, alert_message=msg)
        totalSoldPercentage += sellQty
        
