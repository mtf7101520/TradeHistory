//@version=5
strategy("åŠ¨æ€è°ƒæ•´çš„å–å‡ºç­–ç•¥_CMFä¼˜åŒ–ç‰ˆ", overlay=true, format=format.price, precision=2, calc_on_every_tick=false)

//æ™®é€šå‡çº¿ç»˜åˆ¶ start
// è®¾ç½®EMAçº¿
ema1 = ta.ema(close, 144)
ema2 = ta.ema(close, 169)
ema3 = ta.ema(close, 12)
ema5 = ta.ema(close, 26)
ema6 = ta.ema(close, 9)

// Define channel colors
buyColor = ema3 > ema1 or ema3 > ema2 ? color.new(color.green, 0) : na
sellColor = ema3 < ema2 or ema3 < ema1 ? color.new(color.red, 0) : na

buy2Color = ema6 > ema5 or ema6 > ema3 ? color.new(color.green, 0) : na
sell2Color = ema6 < ema3 or ema6 < ema5 ? color.new(color.red, 0) : na

// Plot the channel
plot(ema1, color=color.black, linewidth=1)
plot(ema2, color=color.purple, linewidth=1)
plot(ema3, color=color.rgb(176, 39, 39), linewidth=2)
plot(ema5, color=color.rgb(0, 0, 0), linewidth=1)
plot(ema6, color=color.rgb(255, 82, 82), linewidth=1)
fill(plot(ema1), plot(ema2), color=buyColor)
fill(plot(ema2), plot(ema1), color=sellColor)
fill(plot(ema3), plot(ema5), color=buy2Color)
fill(plot(ema5), plot(ema3), color=sell2Color)
//æ™®é€šå‡çº¿ç»˜åˆ¶ end

// åŠ¨æ€ä¹°å–å‚æ•°
sellPrecent = input.int(1, title="sellPrecent åŸºæ•°0.3,0.6,0.9", step=1)
buffer = input.float(0.05, title="CMF Buffer", step=0.01)  // è®¾ç½®CMFçš„ç¼“å†²åŒºèŒƒå›´ï¼Œé˜²æ­¢0è½´é™„è¿‘çš„å™ªéŸ³ä¿¡å·
firstSell = input.float(20, title="sellPrecent1", step=1)
secondSell = input.float(40, title="sellPrecent2", step=1)

// æ­¢æŸæ¯”ä¾‹å‚æ•°
stopLossPercentage = input.float(2, title="Stop Loss Percentage", step=1)  // æ­¢æŸæ¯”ä¾‹ï¼Œé»˜è®¤2%

upPercentage15 = 1.09 + (sellPrecent/ 100)  // åŠ¨æ€è°ƒæ•´çš„ä¸Šæ¶¨ 9% åŸºæ•°

// è·å–ä¹°å…¥ä»·æ ¼
var float entryPrice = na

// === CMFä¼˜åŒ–æŒ‡æ ‡ç³»ç»Ÿ START ===
// Chaikin Money Flow (CMF) åŸºç¡€è®¡ç®—
lengthCMF = input.int(20, title="cmfLength", minval=1)
ad = close == high and close == low or high == low ? 0 : ((2 * close - low - high) / (high - low)) * volume
mf = math.sum(ad, lengthCMF) / math.sum(volume, lengthCMF)

// CMFå¼ºåŠ¿åŒºåŸŸå‚æ•°
cmfStrengthPeriod = input.int(5, title="CMFå¼ºåŠ¿ç¡®è®¤å‘¨æœŸ", minval=1, maxval=20, group="CMFå¼ºåŠ¿åŒºåŸŸ")
cmfStrengthThreshold = input.float(0.1, title="CMFå¼ºåŠ¿é˜ˆå€¼", step=0.01, group="CMFå¼ºåŠ¿åŒºåŸŸ")
useCMFStrengthFilter = input.bool(false, title="å¯ç”¨CMFå¼ºåŠ¿åŒºåŸŸè¿‡æ»¤", group="CMFå¼ºåŠ¿åŒºåŸŸ")
cmfConsistencyRatio = input.float(0.7, title="å¼ºåŠ¿æŒç»­æ¯”ä¾‹", minval=0.5, maxval=1.0, step=0.1, group="CMFå¼ºåŠ¿åŒºåŸŸ")

// CMFå¤šç»´åº¦å¼ºåŠ¿åˆ¤å®š
// 1. åŸºç¡€å¼ºåŠ¿ï¼šCMFæŒç»­åœ¨æ­£å€¼åŒºåŸŸ
cmfBullishZone = mf > buffer

// 2. å¼ºåŠ¿ç¡®è®¤ï¼šCMFä¸ä»…ä¸ºæ­£ï¼Œä¸”æœ‰ä¸€å®šå¼ºåº¦
cmfStrongBullish = mf > cmfStrengthThreshold

// 3. æŒç»­å¼ºåŠ¿ï¼šåœ¨æŒ‡å®šå‘¨æœŸå†…å¤§éƒ¨åˆ†æ—¶é—´å¤„äºå¼ºåŠ¿
cmfConsistentStrength = math.sum(cmfBullishZone ? 1 : 0, cmfStrengthPeriod) >= math.round(cmfStrengthPeriod * cmfConsistencyRatio)

// 4. è¶‹åŠ¿å¼ºåŠ¿ï¼šCMFå‘ˆä¸Šå‡è¶‹åŠ¿
cmfMA = ta.sma(mf, 3)
cmfTrendUp = cmfMA > cmfMA[1]

// 5. ç»¼åˆå¼ºåŠ¿æŒ‡æ ‡ï¼ˆæ ¸å¿ƒå¼ºåŠ¿åŒºåŸŸåˆ¤å®šï¼‰
cmfInStrengthZone = cmfBullishZone and cmfConsistentStrength and (cmfStrongBullish or cmfTrendUp)

// 6. å¼±åŠ¿åŒºåŸŸè­¦å‘Š
cmfWeakZone = mf < -cmfStrengthThreshold and math.sum(mf < -buffer ? 1 : 0, cmfStrengthPeriod) >= 3

// CMFç©¿è¶Šä¿¡å·
buyCMF = ta.crossover(mf, buffer)      // ç¬æ—¶èµ„é‡‘æµå…¥ä¿¡å·
sellCMF = ta.crossunder(mf, -buffer)  // ç¬æ—¶èµ„é‡‘æµå‡ºä¿¡å·

// CMFå¯è§†åŒ–
bgcolor(cmfInStrengthZone ? color.new(color.blue, 90) : cmfWeakZone ? color.new(color.red, 95) : na, title="CMFå¼ºåŠ¿/å¼±åŠ¿åŒºåŸŸ")
plot(mf, color=color.purple, linewidth=2, title="CMF")
hline(0, "CMFé›¶è½´", color=color.gray, linestyle=hline.style_dashed)
hline(cmfStrengthThreshold, "å¼ºåŠ¿é˜ˆå€¼", color=color.blue, linestyle=hline.style_dotted)
hline(-cmfStrengthThreshold, "å¼±åŠ¿é˜ˆå€¼", color=color.red, linestyle=hline.style_dotted)
hline(buffer, "ä¹°å…¥ç¼“å†²", color=color.green, linestyle=hline.style_dotted, linewidth=1)
hline(-buffer, "å–å‡ºç¼“å†²", color=color.red, linestyle=hline.style_dotted, linewidth=1)
// === CMFä¼˜åŒ–æŒ‡æ ‡ç³»ç»Ÿ END ===

// å·²å–å‡ºæ¯”ä¾‹å˜é‡
var float totalSoldPercentage = 0.0

// === ä¼˜åŒ–åçš„ä¹°å…¥ä¿¡å·é€»è¾‘ ===
// åœ¨CMFå¼ºåŠ¿åŒºåŸŸå†…è§¦å‘ä¹°å…¥
strongZoneBuySignal = cmfInStrengthZone

// åŸºç¡€ä¹°å…¥ä¿¡å·ï¼šCMFä¸Šç©¿buffer
condition1 = buyCMF

// å¼±åŠ¿åŒºåŸŸé™åˆ¶ï¼ˆåœ¨CMFå¼±åŠ¿åŒºåŸŸå‡å°‘ä¹°å…¥ï¼‰
restrictedBuyZone = cmfWeakZone and useCMFStrengthFilter

// æœ€ç»ˆä¹°å…¥ä¿¡å·æ•´åˆ
buySignal = (condition1 or (useCMFStrengthFilter ? strongZoneBuySignal : false)) and not restrictedBuyZone

// å¼ºåŠ¿åŒºåŸŸä¹°å…¥ä¿¡å·æ ‡è®°
plotshape(useCMFStrengthFilter and strongZoneBuySignal, title="CMFå¼ºåŠ¿åŒºåŸŸä¹°å…¥", 
          location=location.belowbar, style=shape.diamond, 
          color=color.yellow, size=size.tiny)

if (buySignal)
    strategy.entry("Buy", strategy.long)
    entryPrice := close
    totalSoldPercentage := 0.0
    
    // æ„å»ºè§¦å‘æ¡ä»¶çš„è°ƒè¯•ä¿¡æ¯
    debugInfo = "ä¹°å…¥ä¿¡å·è§¦å‘:\n"
    debugInfo := debugInfo + "buyCMF: " + str.tostring(buyCMF) + "\n"
    
    if useCMFStrengthFilter
        debugInfo := debugInfo + "cmfInStrengthZone: " + str.tostring(cmfInStrengthZone) + "\n"
    
    debugInfo := debugInfo + "restrictedBuyZone: " + str.tostring(restrictedBuyZone) + "\n"

    alert(debugInfo, alert.freq_once_per_bar)

// åŠ¨æ€è°ƒæ•´çš„å–å‡ºæ¡ä»¶
sellCondition5 = close >= entryPrice * upPercentage5
sellCondition10 = close >= entryPrice * upPercentage10
sellCondition15 = close >= entryPrice * upPercentage15

// æ•´åˆå–å‡ºä¿¡å·
sellAlert = sellCMF

if (sellAlert and (strategy.position_size > 0))
    alertMessage = "å–å‡ºæé†’:\n"
    alertMessage := alertMessage + "sellCMF: " + str.tostring(sellCMF) + "\n"
if (sellAlert and (strategy.position_size > 0))
    alertMessage := alertMessage + "upPercentage10: " + str.tostring(upPercentage10) + "\n"
    alertMessage := alertMessage + "upPercentage15: " + str.tostring(upPercentage15) + "\n"
    alertMessage := alertMessage + "stopLossPercentage: " + str.tostring(stopLossPercentage) + "\n"
    
    alert(alertMessage, alert.freq_once_per_bar)

// æ­¢æŸé€»è¾‘
stopLossCondition = close <= entryPrice * (1 - stopLossPercentage / 100)
if (stopLossCondition and strategy.position_size > 0)
    strategy.close("Buy")
    totalSoldPercentage := 100.0
    alert("æ­¢æŸä¿¡å·ï¼šè‚¡ä»·è·Œå¹…è¶…è¿‡, ä½äºå‰ä½ " + str.tostring(stopLossPercentage))

// åˆ†é˜¶æ®µå–å‡º
    alert("æ­¢æŸä¿¡å·ï¼šè‚¡ä»·è·Œå¹…è¶…è¿‡, ä½äºå‰ä½ " + str.tostring(stopLossPercentage))

for i = 0 to 2
    if close >= entryPrice * array.get(sellLevels, i) and totalSoldPercentage < 100
        sellQty = math.min(array.get(sellPercentsrcentage)
        strategy.close("Buy", qty_percent=sellQty)
        // è®¡ç®—ç›¸å…³æ•°æ®
        sellPrice = close
        profitPercent = ((sellPrice - entryPrice) / entryPrice) * 100
        remainingPercent = 100 - (totalSoldPercentage + sellQty)
        
        // æ„å»ºæé†’æ¶ˆæ¯
        msg = "ğŸ”” åˆ†æ‰¹å–å‡º #" + str.tostring(i + 1) + "\n"
        msg := msg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        msg := msg + "ğŸ’° å–å‡ºä»·æ ¼: $" + str.tostring(sellPrice, "#.##") + "\n"
        msg := msg + "ğŸ“ˆ æ¶¨å¹…: " + str.tostring(profitPercent, "#.##") + "%\n"
        msg := msg + "ğŸ“Š æœ¬æ¬¡å–å‡º: " + str.tostring(sellQty, "#.##") + "%\n"
        msg := msg + "ğŸ’¼ å‰©ä½™ä»“ä½: " + str.tostring(remainingPercent, "#.##") + "%\n"
        msg := msg + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        // å‘é€æé†’
        alert(msg, alert.freq_once_per_bar_close)

// CMFå¼ºåŠ¿åŒºåŸŸè­¦æŠ¥
alertcondition(cmfInStrengthZone, title="CMFè¿›å…¥å¼ºåŠ¿åŒºåŸŸ", message="CMF Entered Strength Zone - Enhanced Buy Signals Active")
alertcondition(cmfWeakZone, title="CMFè¿›å…¥å¼±åŠ¿åŒºåŸŸ", message="CMF Entered Weak Zone - Buy Signals Restricted")